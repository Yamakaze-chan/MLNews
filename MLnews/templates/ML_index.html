<!DOCTYPE html>
<html lang="vi-VN">
    <head>
        <!--Page setup-->
        <meta charset ="utf-8">
        <!--Title of website-->
        <title>MLnews</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!--icon-->
        <link rel="icon" type="image/png" href="image/icon.png">
        <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <!--Stylesheet-->
        <!-- Reset default styles and add support for google fonts -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Orbitron">
        <!--Fonts-->
        <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet">
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" integrity="sha512-16esztaSRplJROstbIIdwX3N97V1+pZvV33ABoG1H2OyTttBxEGkTsoIVsiP1iaTtM8b3+hu2kB6pQ4Clr5yug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!--CSS-->
        <link rel="stylesheet" href="../static/css/header.css" type="text/css">
        <link rel="stylesheet" href="../static/css/home.css" type="text/css">
        <link rel="stylesheet" href="../static/css/Chatbot.css" type="text/css">
        <link rel="stylesheet" href="../static/css/ML_index.css" type="text/css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <!--Script-->
        <style>
            #text{
              width: 50vh;
              height: 50vh;
              background-color: none;
              color: white;
              font-size: 1rem;
              text-align: center;
              vertical-align: middle;
            }
        </style>
    </head>
<body>
<!--header style="position: fixed; width: 100%; z-index: 21;">
        <div class="search-box">
            <div class="form-group"><input type="text" class="form-control"></div>
        </div>
        <div class="header">

            <div class="logo">
                <h2>boo</h2>
            </div>

            <div class="header-menu">
                <div class="responsive-menu"><i class="fa fa-bars"></i></div>
                <ul class="responsive-sub-menu">
                    <li><a href="./home">home</a></li>
                    <li><a href="./finance">Price</a></li>
                    <li><a href="./chatbot">Bot</a></li>
                    <li><a href="#">services</a></li>
                    <li><a href="#">clients</a></li>
                    <li><a href="#">testimonials</a></li>
                    <li><a href="#">blog</a></li>
                    <li><a href="#">contacts</a></li>
                    <li><a href="#" class="menu-active menu-search"><i class="fa fa-search"></i></a></li>
                </ul>
            </div>

            <div class="head-social-link">
                <ul>
                    <li><a href="./LoginSignup.html">Log in / Sign up</a></li>
                </ul>
            </div>
</header-->

<header class="header">
  <nav>
      <div class="logo">
          <img src="../static/img/logo.png" alt="Logo Image" height="100%">
      </div>
      <div class="hamburger">
          <div class="line1"></div>
          <div class="line2"></div>
          <div class="line3"></div>
      </div>
      <ul class="nav-links">
          <li><a href="home">Trang ch·ªß</a></li>
          <li><a href="finance">Th·ªã tr∆∞·ªùng</a></li>
          <!--li><a href="chatbot">Bot</a></li-->
          <li><a href="weather_forecast">Th·ªùi ti·∫øt</a></li>
          {% if request.user.is_authenticated %}
          <li><a href="show_watch_later">Xem sau</a></li>
          <li><a href="update_info">Th√¥ng tin c√° nh√¢n</a></li>
          {% endif %}
          <li><div class="wrap">
            <div class="search" style="display: flex;">
               <input type="text" class="searchTerm" id="input_search" placeholder="T√¨m ki·∫øm">
               <button type="submit" class="searchButton" id="submit_search" onclick="Search_news()"><i class="fa fa-search"></i></button>
            </div>
            </div></li>
          {% if request.user.is_authenticated %}
          <li>Hello, <text id="fname"></text><text id="lname"></text></li>
          <li><a class="login-button" href="{% url 'logout' %}">ƒêƒÉng xu·∫•t</a></li>
          {% else %}
          <li><a class="login-button" href="{% url 'login' %}">Login</a></li>
          <li><a class="join-button" href="{% url 'signup' %}">Sign up</a></li>
          {% endif %}
          {% if user.is_superuser %}
          <li><a class="login-button" href="{% url 'dashboard' %}">Dashboard</a></li>
          {% endif %}
      </ul>
  </nav>

    <!-- <a href="" class="logo col-2">NEWS</a>
    <input class="menu-btn" type="checkbox" id="menu-btn" />
    <label class="menu-icon" for="menu-btn"><span class="navicon"></span></label>
    <ul class="menu col-10" style="justify-content: center;">
        <li class="col-2"><a href="home">home</a></li>
        <li class="col-2"><a href="finance">Price</a></li>
        <li class="col-2"><a href="chatbot">Bot</a></li>
        <li class="col-2"><a href="show_watch_later">Watch later</a></li>
        <li class="col-2"><form id="form_search" onsubmit="event.preventDefault();" role="search">
          <input id="input_search" type="search" placeholder="Search..." autofocus required style="width: 70%;"/>
          <button id="submit_search" type="submit" onclick="Search_news()" style="width: 30%;">Go</button>    
        </form></li>
        
        <li class="col-2" style="float: right;">
          <div class="head-social-link row">
            {% if request.user.is_authenticated %}
            <p class = "col">{{ request.user.username }}</p>
            <a class = "col" href="{% url 'logout' %}">Logout</a>
            {% else %}
            <a class = "col" href="{% url 'login' %}">Login</a>
            <a class = "col" href="{% url 'signup' %}">Signup</a>
        </div>
        </li>
        {% endif %}
    </ul>
    
    Search -->
    
  </header>

<!--Overlay sum_text-->
<div id="overlay" onclick="off()">
  <div id="text"></div>
</div>


<div class="content" style="z-index: 1;">
    <!--Topic navigation-->
    <div class="topic_nav_container" id="topic_nav_container">
        <div class="topic_item" onclick="Show_topic_content('tin_moi')">Tin m·ªõi</div>
        <div class="topic_item" onclick="Show_topic_content('thoi_su')">Th·ªùi s·ª±</div>
        <div class="topic_item" onclick="Show_topic_content('the_gioi')">Th·∫ø gi·ªõi</div>
        <div class="topic_item" onclick="Show_topic_content('kinh_te')">Kinh t·∫ø</div>
        <div class="topic_item" onclick="Show_topic_content('doi_song')">ƒê·ªùi s·ªëng</div>
        <div class="topic_item" onclick="Show_topic_content('suc_khoe')">S·ª©c kh·ªèe</div>
        <div class="topic_item" onclick="Show_topic_content('giao_duc')">Gi√°o d·ª•c</div>
        <div class="topic_item" onclick="Show_topic_content('the_thao')">Th·ªÉ thao</div>
        <div class="topic_item" onclick="Show_topic_content('du_lich')">Du l·ªãch</div>
        <div class="topic_item" onclick="Show_topic_content('xe')">Xe</div>
        <div class="topic_item" onclick="Show_topic_content('giai_tri')">Gi·∫£i tr√≠</div>
      </div>

    <!--List of news-->
    <div class="container-sm list_news">
    </div>
</div>

<div class="searching_content" style="z-index: 2; display: flex; margin:0 auto 0px auto; top:100px; height: max-content; overflow: hidden;" >
</div>

    <!--Chatbot-->
    <div class="chatbot_container" style="right: 0px; bottom: 30px; position: fixed;z-index: 22; max-width: 100px;max-height: 100px;">
        
        <img src="../static/img/bot.png" width="100" onclick="openForm()">

        <div class="popup_chat" id="popup_chat" style=" display: none; position: fixed; bottom: 0px; right:30px; width: 300px;">
            <!--iframe src="../templates/Chatbot.html" height="500px" width="500px"></iframe-->
            <section class="msger" style="">
                <header class="msger-header">
                  <div class="msger-header-title">
                    Chatbot
                    <i class="fa-solid fa-xmark" onclick="closeForm()" style="float: right;"></i>
                  </div>
                </header>
            
                <main class="msger-chat">
                  <div class="msg left-msg">
                    
            
                    <div class="msg-bubble">
                      <div class="msg-info">
                        <div class="msg-info-name">Chatbot</div>
                        
                      </div>
            
                      <div class="msg-text">
                        Xin ch√†o, t√¥i l√† MLnews chatbot. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n? üòÑ
                      </div>
                    </div>
                  </div>
            
                </main>
            
                <form id="msger-chat" class="msger-inputarea" method="GET">
                  {% csrf_token %}
                  <input type="text" class="msger-input" id="BotContent" name="BotContent" placeholder="Enter your message...">
                  <input type="submit" class="msger-send-btn"></input>
                </form>
                <div id="alert" style="display:none;"></div>
              </section>
          </div>

    </div>

    <!--form action="result">
        <label for="your_name">Your link: </label>
        <input id="your_name" type="text" name="your_name">
        <input class="predict" type="submit" value="OK">
    </form>
    <div class="row">
        <h2><em>{{summary}}</em></h2>
    </div-->
</body>
<script src="../static/js/header.js"></script>
<script src="../static/js/ML_index.js"></script>
<script>
  const msgerForm = get(".msger-inputarea");
  const msgerInput = get(".msger-input");
  const msgerChat = get(".msger-chat");
  // Icons made by Freepik from www.flaticon.com
  const BOT_IMG = "https://image.flaticon.com/icons/svg/327/327779.svg";
  const PERSON_IMG = "https://image.flaticon.com/icons/svg/145/145867.svg";
  const BOT_NAME = "    ChatBot";
  const PERSON_NAME = "B·∫°n";

  $(function() {
    $('#msger-chat').on('submit', function(event) {
      event.preventDefault();
      if(msgerInput.value != ""){
      appendMessage(PERSON_NAME, PERSON_IMG, "right", msgerInput.value);
      
      $.ajax({
        url: "{% url 'bot_response' %}",
        type: 'GET',
        data: $(this).serialize(),
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            //$('#alert').html('<div class="alert alert-success">Thank you for your message!</div>').show();
            msgerInput.value = "";
            console.log(response.bot_content)
            //appendMessage(BOT_NAME, BOT_IMG, "left", response.bot_content);
            appendMessage(BOT_NAME, BOT_IMG, "left", response.bot_content);
          } else {
            $('#alert').html('<div class="alert alert-danger">' + response.errors + '</div>').show();
          }
        }
      });
      msgerInput.value = "";}
    });
    
  });

  function appendMessage(name, img, side, text) {
    var msgHTML =``;
    if(name == BOT_NAME)
    {
    //   Simple solution for small apps
    msgHTML = `
      <div class="msg ${side}-msg">
        
        <div class="msg-bubble">
          <div class="msg-info">
            <div class="msg-info-name">${name}</div>
            <div class="msg-info-time">${formatDate(new Date())}</div>
          </div>
          <div class="msg-text">${text}</div>
        </div>
      </div>
          `}
          else
          {
            msgHTML = `<div class="msg ${side}-msg">
              
              <div class="msg-bubble">
                <div class="msg-info">
                  <div class="msg-info-name">${name}</div>
                  <div class="msg-info-time">${formatDate(new Date())}</div>
                </div>
                <div class="msg-text">${text}</div>
              </div>
            </div>`
          };
    msgerChat.insertAdjacentHTML("beforeend", msgHTML);
    msgerChat.scrollTop += 500;
  }
  // Utils
  function get(selector, root = document) {
    return root.querySelector(selector);
  }
  function formatDate(date) {
    const h = "0" + date.getHours();
    const m = "0" + date.getMinutes();
    return `${h.slice(-2)}:${m.slice(-2)}`;
  }
</script>
<script>
  $.ajaxSetup({
    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
});
  //Watch later
function Watch_later(guid, img_cnt, title, date, img)
{
  console.log(guid, img_cnt, title, date, img)
  // arr = [guid, img, img_content, title, pub_date]
    $.ajax({
        type: "POST",
        url: "{% url 'watch_later' %}",
        data: {
            "guid": guid,
            "title": title,
            "image": img,
            "image_content": img_cnt,
            "published_date": date,
        },
        dataType: "json",
        success: function (data) {
            //any process in data
            alert("successfull")
        },
        failure: function () {
            alert("failure");
        }
    });
}

function off() {
  document.getElementById("overlay").style.display = "none";
}

async function query(data) {
	const response = await fetch(
		"https://api-inference.huggingface.co/models/VietAI/vit5-large-vietnews-summarization",
		{
			headers: { Authorization: "Bearer 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" },
			method: "POST",
			body: JSON.stringify(data),
		}
	);
	const result = await response.json();
	return result;
}

function sum_txt(url)
{
  $.ajax({
        type: "GET",
        url: "{% url 'sum_text' %}",
        data: {
            "url": url
        },
        dataType: "json",
        success: function (data) {
            //any process in data
            console.log(data);
            query({"inputs": data['sum_text']}).then((response) => {
              try{
              console.log(response[0]['summary_text']);
              var summary_para = response[0]['summary_text'];
              $('#text').text(summary_para);
              document.getElementById("overlay").style.display = "block";
              }
              catch(e){
              alert("C√≥ l·ªói v·ªõi ch·ª©c nƒÉng t√≥m t·∫Øt")
            }
            });
            //alert("successfull");
            
        },
        failure: function () {
            alert("failure");
        }
    });
}

$(document).ready(function () {
    $.ajax({
              type: "POST",
              url: "{% url 'get_user_info' %}",
              data: {
                  "uid": {{user.id}},
                  csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              dataType: "json",
              success: function (data) {
                console.log(data.data);
                $('#fname').text(data.data[0][2]);
                $('#lname').text(data.data[0][3]);
              }
            });
          })
</script>
</html>